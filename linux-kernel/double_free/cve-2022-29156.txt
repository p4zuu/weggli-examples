weggli '{
        struct _* $dev;
        $dev->dev.release = _;
        if (_){
                put_device(&$dev->dev);
                NOT: $dev = NULL;
                goto _;
        }

        kfree($dev);
}' .

# NOTE: weggli doesn't match goto destination names. But if kfree() is called in the right goto, and if $dev->dev.release()
# also calls kfree, it's very likely that there will be a double free on error.